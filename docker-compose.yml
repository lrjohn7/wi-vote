services:
  db:
    image: postgis/postgis:16-3.4
    environment:
      POSTGRES_DB: wivote
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d wivote"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  api:
    build: ./packages/server
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-password}@db:5432/wivote
      API_CORS_ORIGINS: ${API_CORS_ORIGINS:-http://localhost:5173}
      REDIS_URL: redis://redis:6379/0
      MRP_TRACES_DIR: /data/mrp_traces
    volumes:
      - ./packages/server/app:/app/app
      - ./packages/server/alembic:/app/alembic
      - ./packages/server/alembic.ini:/app/alembic.ini
      - ./data:/data
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped

  celery-worker:
    build:
      context: ./packages/server
      args:
        INSTALL_EXTRAS: ".[all,migration]"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-password}@db:5432/wivote
      REDIS_URL: redis://redis:6379/0
      MRP_TRACES_DIR: /data/mrp_traces
      SKIP_MIGRATIONS: "true"
    volumes:
      - ./packages/server/app:/app/app
      - ./packages/server/alembic:/app/alembic
      - ./packages/server/alembic.ini:/app/alembic.ini
      - ./data:/data
    entrypoint: []
    command: celery -A app.core.celery_app worker --loglevel=info --concurrency=1
    restart: unless-stopped

  seed:
    build: ./packages/server
    profiles: ["seed"]
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql+psycopg2://postgres:${POSTGRES_PASSWORD:-password}@db:5432/wivote
    volumes:
      - ./data:/data
      - ./packages/server/app:/app/app
    working_dir: /app
    entrypoint: ["python"]
    command:
      - "-c"
      - |
        import subprocess, sys
        scripts = [
            '/data/scripts/load_database.py',
            '/data/scripts/load_demographics.py',
            '/data/scripts/compute_aggregations.py',
            '/data/scripts/backfill_districts.py',
        ]
        for s in scripts:
            print(f'\n{"="*60}')
            print(f'Running {s}')
            print(f'{"="*60}')
            result = subprocess.run([sys.executable, s], env={**__import__('os').environ})
            if result.returncode != 0:
                print(f'FAILED: {s}')
                sys.exit(result.returncode)
        print('\nAll data loaded successfully.')

  tiles:
    build:
      context: ./data
      dockerfile: Dockerfile.tiles
    profiles: ["tiles"]
    volumes:
      - ./data:/data
      - ./packages/client/public/tiles:/output
    environment:
      OUTPUT_DIR: /output

  client:
    build: ./packages/client
    ports:
      - "80:80"
    depends_on:
      - api
    restart: unless-stopped

volumes:
  pgdata:
